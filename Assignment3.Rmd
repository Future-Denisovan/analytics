---
title: 'Assignment 3'
author: "Annie Beyer and Caleb Aguiar"
date: "January 2021"
output: word_document
urlcolor: blue
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages('devtools')#Packages required
#devtools::install_github("ropensci/skimr")
#install.packages('arm')#to plot coefficients 

```

##Upload and Explore Data

```{r}
load(file = "Detergent.RData")
dt <- detergent_DF
library(skimr)
library(psych)
library(ggplot2)
library(arm)
skim(dt)
head(dt)
```

## Question 1

# A

```{r}
#Make Revenue column for each product

dt$T128Revenue <- dt$q_tide128 * dt$p_tide128
dt$T64Revenue <- dt$q_tide64 * dt$p_tide64
dt$WiskRevenue <- dt$q_wisk64 * dt$p_wisk64

TotalRevenue <- sum(dt$T128Revenue) + sum(dt$T64Revenue) + sum(dt$WiskRevenue)

T128Rev <- (sum(dt$T128Revenue) / TotalRevenue) * 100
T64Rev <- (sum(dt$T64Revenue) / TotalRevenue) * 100
WiskRev <- (sum(dt$WiskRevenue) / TotalRevenue) * 100

TotalRevenue1 <- format(round(TotalRevenue, 2), nsmall = 2)
T128Rev1 <- format(round(T128Rev, 2), nsmall = 2)
T64Rev1 <- format(round(T64Rev, 2), nsmall = 2)
WiskRev1 <- format(round(WiskRev, 2), nsmall = 2)

Mean128 <- mean(dt$p_tide128)
Mean64 <- mean(dt$p_tide64)
MeanW <- mean(dt$p_wisk64)

SD128 <- sd(dt$p_tide128)
SD64 <- sd(dt$p_tide64)
SDW <- sd(dt$p_wisk64)

Med128 <- median(dt$p_tide128)
Medn64 <- median(dt$p_tide64)
MednW <- median(dt$p_wisk64)

library(data.table)
Marketshare = c(T128Rev1, T64Rev1, WiskRev1)
MeanPrice = c(Mean128, Mean64, MeanW)
MedianPrice = c(Med128, Medn64, MednW)
Std.Dev = c(SD128, SD64, SDW)
Product <- c("Tide 128 oz", "Tide 64 oz", "Wisk 64 oz")

MarketShare <- data.frame(Product, Marketshare, MeanPrice, MedianPrice, Std.Dev)

describe(dt)
                          
MarketShare            
```

+---------------+---------------+-------------+--------------+-----------+
| Product       | Marketshare   | Mean Price  | Median Price | Std. Dev |          
+===============+===============+=============+==============+===========+
| Tide 128 oz   |      56.9%    |   8.36      |    8.48      |  .76      |
+---------------+---------------+-------------+--------------+-----------+
| Tide 64 oz    |      26.3%    |   4.36      |    4.42      |  .40      |
+---------------+---------------+-------------+--------------+-----------+
| Wisk 64 oz    |      16.8%    |   4.07      |    4.19      |  .49      |
+---------------+---------------+-------------+--------------+-----------+


# B
Price Gap

```{r}
dt$PriceGap1 <- dt$p_tide128 - dt$p_tide64
dt$PriceGap2 <- dt$p_tide64 - dt$p_wisk64

MeanPG1 <- mean(dt$PriceGap1)
MeanPG2 <- mean(dt$PriceGap2)

SDPG1 <- sd(dt$PriceGap1)
SDPG2 <- sd(dt$PriceGap2)

MedPG1 <- median(dt$PriceGap1)
MedPG2 <- median(dt$PriceGap2)

MeanPriceGap = c(MeanPG1, MeanPG2)
MedianPriceGap = c(MedPG1, MedPG2)
Std.DevPriceGap = c(SDPG1, SDPG2)                  
PriceGap <- c("Tide128- Tide64", "Tide64 - Wisk64") 

PriceGap <- data.frame(PriceGap, MeanPriceGap, MedianPriceGap, Std.DevPriceGap)

PriceGap 
```

+---------------+---------------+-------------+-----------+
| PriceGap      | MeanPriceGap  | MedianPrGap | Std. Dev  |          
+===============+===============+=============+===========+
| Tide128-Tide64|   3.9877679   |  4.094000   |  0.8705   | 
+---------------+---------------+-------------+-----------+
| Tide64 -Wisk64|   0.3034887   |  0.260714	 |  0.5859   |
+---------------+---------------+-------------+-----------+


# C
Histograms
```{r}
par(mfrow=c(1,2))#Set the plotting area into a 1*2 array

hist(dt$PriceGap1, freq = F, col = "steelblue", breaks = 50, xlab = "Price Gap 1 ($)", main = "Price Gap of Tide 128 - Tide 64")
hist(dt$PriceGap2, freq = F, col = "orange", breaks = 50, xlab = "Price Gap 2 ($)", main = "Price Gap of Tide 64 - Wisk 64")

par(mfrow=c(1,1))
```


# D
Discussion:
What do you learn from the price gap histograms and summary statistics for your analysis above? 

Examining the revenue market share, Tide 128oz is about double the price, and double the amount of revenue of Tide 64oz. 

This would suggest that the number of purchases made of each product is the same.

Tide 64 is more expensive than Wisk 64 on average.

The variability between Tide 128 and Tide 64 is less than the variability between Tide 64 and Wisk 64. 

Is there enough variation in the price gaps across stores and weeks to estimate the cross price elasticities between the two Tide pack sizes and Wisk 64?

Absolutely, we have 10



## Question 2

# A 
Sales velocity for Tide 128 and Tide 64

```{r}
dt$svelocity128 <- (dt$q_tide128/dt$acv)
dt$svelocity64 <- (dt$q_tide64/dt$acv)

SalesVelocity128 <- sum(dt$svelocity128)
SalesVelocity64 <- sum(dt$svelocity64)

SalesVelocity128
SalesVelocity64
```

# B
Discussion:
What is the purpose of dividing unit sales by ACV to construct the dependent variable?


The ACV is a measure of how large the store is. By dividing by ACV, this allows us to normalize the data so we can compare the two products equally. We would expect a larger store to be more sensitive to price changes, as customers are more interested in price at a large store, while customers at a small store are more likely to prioritize the convenience of the location. Additionally, not all stores may sell each product every single week (whether that is due to operational supply difficulties, a lack of data recording, etc...)


# C
Log linear demand model 
```{r}
lm128 = lm(log(svelocity128) ~ log(p_tide128)+log(p_tide64), data = dt)
lm64 = lm(log(svelocity64) ~ log(p_tide128)+log(p_tide64), data = dt)

summary(lm128)
summary(lm64)

lm128_coef<- summary(lm128)$coefficients
lm64_coef<-summary(lm64)$coefficients#Lets graph these coefficients so we can see all these at a glance

pe_graph<-c(lm64_coef[2:3,1],lm128_coef[2:3,1])
pe_graph

barplot(pe_graph, main = "Price Elasticity", xlab = "Tide64's price elasticities              Tide128's price elasticities", col = rainbow(4), names.arg = c('Cross','Own', 'Own','Cross' ))

```


# D
Discussion:
Discuss whether the demand estimates (own and cross price elasticities) make sense. Are the magnitudes and signs of the estimated parameters as you would expect? 

This regression shows that Tide128 and Tide64 are highly elastic, and there cross price elasticities are also elastic, but not as much. Tide128 demand is only slightly sensitive to change in Tide64 price. This does not make a lot of sense, because their price gap is sometimes at zero, and if that is the case customers are going to be falling over themselves to buy the Tide128 and not bother with Tide64. We need to examine if there is something going on here, is there more affluent locations where Tide64 is selling the same as Tide128 at a lower income area, or is there a seasonal element where people buy more Tide when they wash more clothes from sweating.

OwnPE_128 = -4.57 Elastic
OwnPE_64 = -3.9 Elastic

CrossPE_128 = 0.31 Not that elastic, this is similar to addictive substances
CrossPE_64 = 1.28 Elastic

## Question 3

# A
Time Trend 

```{r}
dt$week<-as.integer(dt$week)
lm128_B <- lm(log(svelocity128) ~ log(p_tide128)+log(p_tide64) + week, data = dt)
lm64_B <- lm(log(svelocity64) ~ log(p_tide128)+log(p_tide64) + week, data = dt)

lm128_Ba<-tidy(lm128_B) 
lm64_Ba<-tidy(lm64_B)

kable(lm128_Ba[c(1:3),], digits = 4)
kable(lm64_Ba[c(1:3),], digits = 4)

summary(lm128_B)
summary(lm64_B)


```

# B
Discussion:
Explain why adding a time trend is important here. Discuss whether the demand estimates now make sense. Is there an improvement over the model specification in question 2?

Time trend is extremely important, once we accounted for seasonal trends, it improves the previous model immensely. This makes sense, since the purchase of detergent is likely to be driven by weather(depends on the location, but think about people spending alot of time outside vs inside would change the rate at which the product is used). It is important not to try to build too many assumptions into this. Tide128 is a product that may take a few weeks to consume, and so if there is a seasonal effect driving its consumption there will be a lag effect. The big takeaway is that incorporating the week that the detergent was purchased into our model we get a more accurate model.

See the table below for a comparison of the multiple R squared values. Once we implemented dummy variables for time, our model was able to capture between roughly 8-10% more of the variation.

+-------------------+---------------+-------------------+-----------------+
| Tide64 Linear-Log | Tide64 w/Time | Tide128Linear-Log | Tide 128 w/Time |         
+===================+===============+===================+=================+
| R^2       0.2657  | R^2    0.357  | R^2       0.2072  | R^2     0.2822  | 
+-------------------+---------------+-------------------+-----------------+

## Question 4

# A

195/300 weeks had at least one promotion ####?????#####******

```{r}
library(dplyr)
detergent_promos <- dt %>% select(week, promoflag) %>% 
  filter(promoflag == 1)

totalweeks<-length(unique(dt$week))

promoweeks<-length(unique(detergent_promos$week))

store_week_fraction <- paste(promoweeks,totalweeks, sep = '/')

store_week_fraction #Did we lose some data, there isn't the expected 300 weeks.

sum(dt$promoflag)

detergent_DF_2 = subset(detergent_DF, promoflag != 1)

```


# B

```{r}
detergent_DF_2$svelocity128 <- (detergent_DF_2$q_tide128/detergent_DF_2$acv)
detergent_DF_2$svelocity64 <- (detergent_DF_2$q_tide64/detergent_DF_2$acv)

SalesVelocity128_B <- sum(detergent_DF_2$svelocity128)
SalesVelocity64_B <- sum(detergent_DF_2$svelocity64)

lm128_C = lm(log(svelocity128) ~ log(p_tide128)+log(p_tide64) + week, data = detergent_DF_2)
lm64_C = lm(log(svelocity64) ~ log(p_tide128)+log(p_tide64) + week, data = detergent_DF_2)

#summary(lm128_C)
#summary(lm64_C)

lm128_Ca<-tidy(lm128_C)
lm64_Ca<-tidy(lm64_C)

kable(lm128_Ca[c(1:3),], digits = 4)
kable(lm64_Ca[c(1:3),], digits = 4)

```


# Discussion
Discuss whether the demand estimates (own and cross price elasticities) now make sense - is there an improvement over the specification in question 3? Provide some intuition for the change in the estimated own-price effects.


BEFORE: 
OwnPE_128 = -4.57
OwnPE_64 = -3.9

CrossPE_128 = 0.31
CrossPE_64 = 1.28

AFTER: 
OwnPE_128 = -3.15
OwnPE_64 = -1.86


CrossPE_128 = -0.0055
CrossPE_64 = 0.36

## Question 5

Store Fixed Effect

# A

```{r}
lm128_D<-lm(log(svelocity128) ~ log(p_tide128)+log(p_tide64) + week + factor(store), data = detergent_DF_2)
lm64_D <- lm(log(svelocity64) ~ log(p_tide128)+log(p_tide64)+ week+ factor(store), data = detergent_DF_2)

library(broom)
library(knitr)

lm128_D <- tidy(lm128_D)
lm64_D <- tidy(lm64_D)



kable(lm64_D[c(1:4),], digits = 4)
kable(lm64_Ca[c(1:3),], digits = 4)


kable(lm128_D[c(1:4),], digits = 4)
kable(lm128_Ca[c(1:3),], digits = 4)




```

# B
Discussion:
Do the estimates of own and cross price elasticties reveal an improvement over the model specification
in question 4? 

Yes, cross price elasticities originally were extremely small numbers, .0039 and .049. This would suggest that the within brand detergent was very inelastic, and not doing much to change the demand. We improved the model for both own and cross, and we can see that here.

# C 

```{r}
lm128_E = lm(log(q_tide128) ~ log(p_tide128)+log(p_tide64) + log(week) + factor(store), data = detergent_DF_2)
lm64_E = lm(log(q_tide64) ~ log(p_tide128)+log(p_tide64) + log(week)+ factor(store), data = detergent_DF_2)

lm128_E = tidy(lm128_E)
lm64_E = tidy(lm64_E)

kable(lm128_D[c(1:3),], digits = 4)
kable(lm128_E[c(1:3),], digits = 4)

kable(lm64_D[c(1:3),], digits = 4)
kable(lm64_E[c(1:3),], digits = 4)

```


Discussion:
How do the elasticity estimates and the time trend compare across these two regressions? Is the difference (or absence of a difference) as expected? 

Not much of a difference here, using unit sales instead of velocity did not have much of an effect. This doesn't make sense conceptually, large stores and small stores should have variation between them. When we removed our velocity it barely changed the elasticities.



## Question 6

r = 25%
C = 0.25 / oz

Q128 = A128 * P128^(-2.11) * P64^(0.211)
Q64 = A64 * P128^(1.1627) * P64^(-1.585)

# A

```{r}
baseprice128 = mean(detergent_DF_2$p_tide128)

```

# B
```{r}
baseprice64 = mean(detergent_DF_2$p_tide64)
```

# C / D

```{r}
stores <- length(unique(detergent_DF_2$store))

basevolume128 = stores * 52 * mean(detergent_DF_2$q_tide128)
basevolume64 = stores * 52 * mean(detergent_DF_2$q_tide64)

basevolume128
basevolume64

```

# E

Base Profits:
pi128=Q_128*(P_128(1-r)-C)

```{r}
Bprofit128 = basevolume128 * ((baseprice128*0.75) - 0.25)
Bprofit64 = basevolume64 * ((baseprice64*0.75) - 0.25)

BaseTotalProfit <- Bprofit128 + Bprofit64
BaseTotalProfit

```


# F

Scenario1: 5% increase in price for both 128 and 64
Scenario2: 5% decrease in price for both 128 and 64
Scenario3: 5% increase in price 128 and 5% decrease in 64
Scenario4: 5% decrease in price 128 and 5% increase in 64

r = 25%
C = 0.25 / oz

Q128 = A128 * P128^(-2.11) * P64^(0.211)
Q64 = A64 * P128^(1.1627) * P64^(-1.585)


```{r}
pricechange = 0.05

# Specify the function
demand_change <- function(price_change1, price_change2, price_elasticity1, price_elasticity2, basequantity) {
   
   # New demand from method 1 
   quantity_change_1 = ((1 + price_change1)^price_elasticity1) * ((1 + price_change2)^price_elasticity2)
    
   #Get new quantity from ratio of new / old 
   
   NewQuantity = quantity_change_1 * basequantity
   
   # Return results as a list
   return(NewQuantity)
}

```

Running the Function
```{r}
New_Q128_1 <- demand_change(0.05, 0.05, -2.11, 0.211, basevolume128)
New_Q64_1 <- demand_change(0.05,0.05,1.16,-1.585, basevolume64)

New_Q128_2 <- demand_change(-0.05, -0.05, -2.11, 0.211, basevolume128)
New_Q64_2 <- demand_change(-0.05,-0.05,1.16,-1.585, basevolume64)

New_Q128_3 <- demand_change(0.05, 0.05, -2.11, 0.211, basevolume128)
New_Q64_3 <- demand_change(-0.05,-0.05,1.16,-1.585, basevolume64)

New_Q128_4 <- demand_change(-0.05, -0.05, -2.11, 0.211, basevolume128)
New_Q64_4 <- demand_change(0.05,0.05,1.16,-1.585, basevolume64)

```

# G
```{r}
#Total Profit calculations
TotalProfit1 <- (New_Q128_1* (baseprice128*1.05))*(New_Q64_1* (baseprice64*1.05))

TotalProfit2 <- (New_Q128_2*(baseprice128*0.95))*(New_Q64_2* (baseprice64*0.95))

TotalProfit3 <- (New_Q128_3*(baseprice128*1.05))*(New_Q64_3*(baseprice64*0.95))

TotalProfit4 <- (New_Q128_4*(baseprice128*0.95))*(New_Q64_4* (baseprice64*1.05))
```


: Table of quantities sold and profits when Tide changes the price of Tide 64 and 128. Price changes are shown in percentages

```{r}
del_price_128 = c(0.05, -0.05, 0.05, -0.05)
del_price_64 = c(0.05, -0.05, -0.05, 0.05)
q_128 = c(New_Q128_1, New_Q128_2, New_Q128_3, New_Q128_4)
q_64 = c(New_Q64_1, New_Q64_2, New_Q64_3, New_Q64_4)
TotalProfits = c(TotalProfit1, TotalProfit2, TotalProfit3, TotalProfit4)

Price_Change<- as.factor(paste('128',del_price_128,'64',del_price_64, sep = "|"))

NewTable <- data.frame(del_price_128, del_price_64, q_128, q_64,Price_Change, TotalProfits)

NewTable

plot(NewTable$Price_Change, NewTable$TotalProfits, pch=19)


```


## Question 7

a. What is the extent of cannibalization within the Tide product line? 
b. Does Tide face a competitive threat from Wisk? 
c. How do you evaluate the current pricing tactics? Do you recommend changes? 










